var cryptoJs = {};
cryptoJs['SHA256'] = require('CryptoJS/rollups/sha256.js').CryptoJS.SHA256

var pHeader = {"alg":"RS256","typ":"JWT"}
var sHeader = JSON.stringify(pHeader);
var encodedHeader = Base64EncodeUrl(btoa(sHeader));
//console.log("encodedHeader" + encodedHeader);

var now = new Date();
var oneHourExpiration = ((now.getTime()-now.getMilliseconds())/1000)+3000;//3000, not 3600 which is 1 hour
console.log(oneHourExpiration);

var pClaim = {};
pClaim.aud = " https://www.googleapis.com/oauth2/v3/token";
pClaim.scope = " https://www.googleapis.com/auth/spreadsheets";
pClaim.iss = " scriptr-io-service@alert-smoke-140013.iam.gserviceaccount.com";
pClaim.exp = oneHourExpiration;
pClaim.iat = Date.now();
var sClaim = JSON.stringify(pClaim);
var encodedClaim = Base64EncodeUrl(btoa(sClaim));
//console.log("encodedClaim" + encodedClaim);

var byteArray = encodedHeader + "." + encodedClaim;


var secret = "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDaJnNwFBAozOaX\nM6Ewo9ciK48pGVBB3nHOf9nUyE3Ux92H/hhvH83Xxy2zqS/f9fFJWOi+e+Z/oJmS\n1aYo5u1xDBPnhMZ7C6+7BLPX0o/5CF3QYlzXEe4goU9N5XyE3M0qBP3r7zaqgHuQ\nO+sTnhBWG1aKm5tA18wYA61fmSP+rdorTr3Jo39KQjAFiOGZ50HsdkR8lx8WYkpa\ntNRazCnB26wGRFeOLpVBBVpvQIX1TqHCR8Ggowpr7EpfbJXct0DdM8N2WKWA7+np\n63iBO3srL5c68PuZMevvp9ZZ4/ROKbbCuVQdPh8tjnlkV4HRUvDal343oVbRnCNJ\nBQ1tz82LAgMBAAECggEAYqGl6dO4ZqoVy+E1DOfW+gUVyjA+wDlR3Vqi43jY786Z\n08XHyF5p1BijCisBkVICkPYY7R7Z3XSAWwosASw/yK/8Q94dWz6yam063ua934uv\n1urSLQ9XSfuE/qQ2g1/NhyUQpV7XqYlD1LeyloENw9DCdRLbxBqNlYH8HlAAHUIp\nu1cYXLNjDOBiVWIJtI36f9Q7s3Khkqfx62jlqgDoLyaRK2+Dkk5L8jfkciDfDTiG\nzz7aq/qkTh7txAtlvnKmNAuAOmARnDgSIZbPIsJdObPkcu/cS1W/bl++l9GoD0Tq\nP2X2cB7zat+hNYeXhn9eAeSL5J8ayvqU+MgfnlheaQKBgQDwWd7L4yytTKmC+ZPz\nn1NwtK8YHdwACfPtqoxIssNH6RAr9cHcQDPmwl/S+y+O5jbzrNECPlALZMLPQPXp\n2AEDneDEp2ZvF216hXSa+05zlkfEdHV2G5qrXFDCVacPjqYfueve2Z3LWkaD/gRt\nW/1vx+C+SiOwgBKhZjtRvlXmtQKBgQDoWopksBAQIgsJWq12ShCA5a2fFuPJpvr+\nFNiKzUrYDI6SLoSL5OoH6zRe2xCZxIuHNSXu+PG83jMddRL7PrBXZu5BV8/noj+f\nQAgZcUgVHoz3zl4nSF7a3n6Yk+Udwu9+fsZFdeWRtli+n44SFOiJhTfldOhueuRE\nTLeja+FLPwKBgAdh60r97lhgW3CPc/DuuuRiWGJ4QFKr+5cYPvjYrNDfosSG5u55\n9l4nKERVvM852QRBEaZs/Y5sCOPOzf7hyJ4w0j+YGLhe0tkJklxUTcOVIR0yqoz3\nKhgLXNurP9dlfUrKLimJK6ScYEAbpE0rnyw4ynlt04zPUkMs3bOUEhVlAoGAW7ZB\nIfUMohGN4adVCHe7g+UkXsMeLh4mu9tmjYLyo8xxCeoqjz1P0shX54j4SHl3yWqF\nCopggHgEHQB0+Y6I9DbAnDIY8gjsq+MOT1yTYyKn6bgfGcpLBoED3x2hNdoXxgos\nIIakkpsy9CruXNy73Gwk4AEBLXp8Vykg4vRV/OkCgYEA0Hh8CawGC6iSBvo/3Jk0\nqVvc/meYlenVr0J+Ym6pEFUEGwdHOMz0eQtAijE8tAo5TTxlv2S0BE1Fa3Bp0Ksn\nr+MnseVm5L2b96VylSRkqxBM4qRf2LUhu8tYtrf68jFWC4PWb18If3zvwC8D0BS8\nhx+7biTRKYD+ab5IGl6HB7k=\n-----END PRIVATE KEY-----\n";
var signature = cryptoJs.SHA256(byteArray, secret);
var encodedSignature = Base64EncodeUrl(btoa(signature));
//console.log("Signature: " + encodedSignature);

var sJWS = byteArray + "." + encodedSignature;
//console.log("JWT: " + sJWS);

function Base64EncodeUrl(str){
    return str.replace(/\+/g, '-').replace(/\//g, '_').replace(/\=+$/, '');
}

var http = require("http");
var requestObject = {
  "url": " https://www.googleapis.com/oauth2/v3/token",
  "method": "POST",
  "headers": {"Content-Type":"application/x-www-form-urlencoded"},
  "params": {"grant_type":"urn:ietf:params:oauth:grant-type:jwt-bearer","assertion":sJWS}
}


var response = http.request(requestObject);
var responseBodyStr = response.body;
console.log(responseBodyStr);
var token = JSON.parse(responseBodyStr.access_token);
console.log(token);